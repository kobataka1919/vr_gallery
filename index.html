<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ジョイスティック＆フリック操作対応テンプレート</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <style>
    body, html { margin: 0; height: 100%; overflow: hidden; }
    #joystick {
      position: fixed;
      left: 20px;
      bottom: 20px;
      width: 120px;
      height: 120px;
      background: rgba(0,0,0,0.3);
      border-radius: 50%;
      touch-action: none;
      user-select: none;
    }
    #joystickInner {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 60px;
      height: 60px;
      margin-left: -30px;
      margin-top: -30px;
      background: rgba(255,255,255,0.7);
      border-radius: 50%;
      touch-action: none;
      user-select: none;
    }
  </style>
</head>
<body>

<!-- A-Frame シーン -->
<a-scene embedded>
  <a-box position="0 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
  <a-sky color="#ECECEC"></a-sky>
  <a-entity id="cameraRig" position="0 1.6 0">
    <a-camera id="camera" look-controls="enabled: false"></a-camera>
  </a-entity>
</a-scene>

<!-- ジョイスティックUI -->
<div id="joystick">
  <div id="joystickInner"></div>
</div>

<script>
  const joystick = document.getElementById('joystick');
  const joystickInner = document.getElementById('joystickInner');
  const cameraRig = document.getElementById('cameraRig');

  let dragging = false;
  let startX, startY;
  let maxRadius = 50;

  let joyX = 0, joyY = 0;

  joystick.addEventListener('pointerdown', e => {
    dragging = true;
    startX = e.clientX;
    startY = e.clientY;
  });

  window.addEventListener('pointermove', e => {
    if (!dragging) return;
    let dx = e.clientX - startX;
    let dy = e.clientY - startY;
    let dist = Math.min(maxRadius, Math.sqrt(dx*dx + dy*dy));
    let angle = Math.atan2(dy, dx);

    joyX = Math.cos(angle) * (dist / maxRadius);
    joyY = Math.sin(angle) * (dist / maxRadius);

    joystickInner.style.transform = `translate(${joyX * maxRadius}px, ${joyY * maxRadius}px)`;
  });

  window.addEventListener('pointerup', e => {
    dragging = false;
    joyX = 0; joyY = 0;
    joystickInner.style.transform = `translate(0px, 0px)`;
  });

  // フリック操作検出用
  let flickStartX = null;
  let flickStartY = null;
  let flickThreshold = 50; // 最小移動量

  window.addEventListener('touchstart', e => {
    if(e.touches.length === 1){
      flickStartX = e.touches[0].clientX;
      flickStartY = e.touches[0].clientY;
    }
  });

  window.addEventListener('touchend', e => {
    if(flickStartX === null || flickStartY === null) return;
    let flickEndX = e.changedTouches[0].clientX;
    let flickEndY = e.changedTouches[0].clientY;
    let dx = flickEndX - flickStartX;
    let dy = flickEndY - flickStartY;

    if(Math.abs(dx) > flickThreshold || Math.abs(dy) > flickThreshold){
      // フリック方向を判定
      let direction;
      if(Math.abs(dx) > Math.abs(dy)){
        direction = dx > 0 ? 'right' : 'left';
      } else {
        direction = dy > 0 ? 'down' : 'up';
      }
      console.log('Flick detected:', direction);
      alert('フリック方向: ' + direction);
    }
    flickStartX = null;
    flickStartY = null;
  });

  // 毎フレームカメラ移動（ジョイスティックに応じて）
  function animate(){
    if(joyX !== 0 || joyY !== 0){
      // カメラリグの移動: joyXは左右, joyYは前後（カメラの向きに合わせて調整）
      let rigPos = cameraRig.object3D.position;
      // 前方向ベクトル（z軸）
      let forward = new THREE.Vector3(0,0,-1);
      let right = new THREE.Vector3(1,0,0);
      let moveSpeed = 0.05;

      // Y軸回転（水平回転）だけ取得（カメラのyaw）
      let rotation = cameraRig.object3D.rotation;
      let yaw = rotation.y;

      // 前方向と右方向をカメラの向きに合わせて回転
      forward.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
      right.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);

      // 移動量
      rigPos.add(forward.multiplyScalar(joyY * moveSpeed));
      rigPos.add(right.multiplyScalar(joyX * moveSpeed));
    }
    requestAnimationFrame(animate);
  }
  animate();

</script>

</body>
</html>

